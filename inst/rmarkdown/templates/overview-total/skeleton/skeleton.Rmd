---
title: "Översiktsrapport Spöreg"
author: "SLU Aqua"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output:
 #pdf_document: default
  word_document: default
  html_document: default
---

```{r setup, include=FALSE}
### Set up control, unmask these lines when used locally ##
## In that way all functions from the R/-folder is loaded into the knit-session
#library(devtools) # unmask this
#devtools::load_all() # unmask this
### End local set up

### Set ut
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(warning = FALSE)

# Load libraries
library(dplyr)
library(tidyr)
library(readxl)
library(ggplot2)
library(sporegr)
library(ggthemes)
library(janitor)

# Load user data
users <- sporegr::read_anvlista()
nusers <- nrow(users)

# Users by organisation table
users_tab <- users %>%
  group_by(Organisation) %>%
  summarise(N = n()) %>%
  arrange(desc(N))

### Trip data 
trips <- sporegr::read_resa_clean()
first_date <-  min(trips$RESEDATUM)
last_date <- max(trips$RESEDATUM)
ntrips <- nrow(trips)
ntrips.live <- nrow(trips[trips$EFTERREGISTRERING=="N",])
andeltrips.live <- round(ntrips.live/ntrips*100, 2)

# Active users by year
users_temp <- trips %>% 
  group_by(ANVID, Year) %>% 
  summarize(N.trips = n())
users_tab2 <- users_temp %>% 
  group_by(Year) %>% 
  summarize('Aktiva användare' = n()) %>% 
  rename(År = Year)


# Trips by area and year table
trips_tab <- trips %>%
  count(Year, FANGOMR) %>%
  arrange(desc(Year)) %>% 
  pivot_wider(names_from = Year,
              values_from = n,
              values_fill = 0) %>%
  rowwise() %>%
  mutate(Totalt = sum(c_across(where(is.numeric)))) %>%
  ungroup() %>%
  arrange(desc(Totalt)) %>% 
  adorn_totals("row", fill = "Totalt") %>%
  relocate(Totalt, .after = FANGOMR) 
  
 
# Target species by area and year table
target_tab <- trips %>% 
  rename(Målart = MALART) %>% 
  count(FANGOMR, Målart) %>%
  pivot_wider(names_from = FANGOMR,
              values_from = n,
              values_fill = 0) %>%
  rowwise() %>%
  mutate(Totalt = sum(c_across(where(is.numeric)))) %>%
  ungroup() %>%
  arrange(desc(Totalt)) %>% 
  adorn_totals("row", fill = "Totalt") %>%
  relocate(Totalt, .after = Målart) 



### Catch data 
catches <- sporegr::read_fangst_clean()
catches.trips <- dplyr::left_join(catches, trips, by="UUID")

### Other events  
other <- sporegr::read_ovrighandelse_clean()
trips.other <- dplyr::left_join(trips, other, by="UUID")
nother <- nrow(other)


# Fish (number, regardless of species) by area and year table
nfish <- nrow(catches)
catch_tab <- catches.trips %>%
  count(Year, FANGOMR) %>%
  arrange(desc(Year)) %>% 
  pivot_wider(names_from = Year,
              values_from = n,
              values_fill = 0) %>%
  rowwise() %>%
  mutate(Totalt = sum(c_across(where(is.numeric)))) %>%
  ungroup() %>%
  adorn_totals("row", fill = "Totalt") %>%
  relocate(Totalt, .after = FANGOMR) %>% 
  arrange(desc(Totalt))

# Species total and size info table
species_tab <- catches %>%
  mutate(Art = ARTBEST) %>% 
  group_by(Art) %>%
  summarize(Totalt=n(), 
            Medellängd = round(mean(LANGD, na.rm = TRUE), 0), 
            Maxlängd = max(LANGD, na.rm = TRUE),
            Maxvikt = max(VIKT, na.rm = TRUE), .groups = "drop") %>%
  mutate(Medellängd = if_else(is.infinite(Medellängd), as.numeric(NA), Medellängd),
         Maxlängd = if_else(is.infinite(Maxlängd), as.numeric(NA), Maxlängd),
         Maxvikt = if_else(is.infinite(Maxvikt), as.numeric(NA), Maxvikt))%>%
  arrange(desc(Totalt))

# make vector with species above threshold catch for inclusion in some figures:
species_keep <- species_tab %>% 
  filter(Totalt >10) %>% 
  pull(Art)

####### Before moving on - manually check which species, areas and years that have enough data #####
species_by_area <- table(catches.trips$ARTBEST, catches.trips$FANGOMR)
 # table(catches.trips$ARTBEST, catches.trips$FANGOMR, catches.trips$Year)
 # table(catches.trips$ARTBEST, catches.trips$FANGOMR)
 # table(catches.trips$ARTBEST, catches.trips$Year)
## Start with pooled by area, for Gädda, Abborre, Öring, Röding, Lax, Gös och Harr - möjligen makrill också
 
## FÖRSLAG - kör figurer först per art (för relevanta områden) och sen per område
# 1 gädda med FANGOMR som kolumner. 
# 2 öring Kust, Vänern, Vättern och ÖVrigt vatten
# 3 abborre, Kust, Mälaren, 
# 4 Vättern, röding, och då ta med öring och lax - akta enstaka fisk i andra vatten
# 5 Vänern, gädda, lax, öring  

#### Beräkna även indikatorer ####
Lindicators.pike <- catches.trips %>% 
  filter(ARTBEST=="Gädda") %>% 
  drop_na(LANGD) %>% # en användare som bulkreggat gäddor utan langd, behöver ta bort sådana
  mutate(meterfisk = ifelse(LANGD>=100, 1, 0),
         storfisk  = ifelse(LANGD >=65, 1, 0)) %>% 
  group_by(FANGOMR, Year) %>% 
  summarize('Antal fiskar' =n(),
            L10 = round(quantile(LANGD, probs = c(0.1), na.rm=T),0),
            L50 = round(quantile(LANGD, probs = c(0.5), na.rm=T), 0),
            L90 = round(quantile(LANGD, probs = c(0.9), na.rm=T), 0),
            'Andel >100cm' = round(sum(meterfisk)/n()*100, 1),
            'Andel >65cm'  = round(sum(storfisk)/n()*100, 0),
            M65 = round(mean(LANGD[LANGD>65], na.rm=T), 0)) %>% 
  filter(`Antal fiskar` >9)

# Öring
Lindicators.trout <- catches.trips %>% 
  filter(ARTBEST=="Öring") %>% 
  drop_na(LANGD) %>% 
  mutate(storfisk = ifelse(LANGD>=50, 1, 0)) %>% 
  group_by(FANGOMR, Year) %>% 
  summarize('Antal fiskar' =n(),
            L10 = round(quantile(LANGD, probs = c(0.1), na.rm=T),0),
            L50 = round(quantile(LANGD, probs = c(0.5), na.rm=T), 0),
            L90 = round(quantile(LANGD, probs = c(0.9), na.rm=T), 0),
            'Andel >50cm' = round(sum(storfisk)/n()*100, 0),
            M50 = round(mean(LANGD[LANGD>50], na.rm=T), 0)) %>% 
    filter(`Antal fiskar` >9)


# Röding
Lindicators.char <- catches.trips %>% 
  filter(ARTBEST=="Röding") %>% 
  drop_na(LANGD) %>% 
  mutate(halvmeterfisk = ifelse(LANGD>=50, 1, 0)) %>% 
  group_by(FANGOMR, Year) %>% 
  summarize('Antal fiskar' =n(),
            L10 = round(quantile(LANGD, probs = c(0.1), na.rm=T),0),
            L50 = round(quantile(LANGD, probs = c(0.5), na.rm=T), 0),
            L90 = round(quantile(LANGD, probs = c(0.9), na.rm=T), 0),
            'Andel >50cm' = round(sum(halvmeterfisk)/n()*100, 0),
            M50 = round(mean(LANGD[LANGD>50], na.rm=T), 0)) %>% 
    filter(`Antal fiskar` >9)


# Lax
Lindicators.salm <- catches.trips %>% 
  filter(ARTBEST=="Lax") %>% 
  drop_na(LANGD) %>% 
  mutate(halvmeterfisk = ifelse(LANGD>=50, 1, 0)) %>% 
  group_by(FANGOMR, Year) %>% 
  summarize('Antal fiskar' =n(),
            L10 = round(quantile(LANGD, probs = c(0.1), na.rm=T),0),
            L50 = round(quantile(LANGD, probs = c(0.5), na.rm=T), 0),
            L90 = round(quantile(LANGD, probs = c(0.9), na.rm=T), 0),
            'Andel >50cm' = round(sum(halvmeterfisk)/n()*100, 0),
            M50 = round(mean(LANGD[LANGD>50], na.rm=T), 0)) %>% 
    filter(`Antal fiskar` >9)


# Gös
Lindicators.gos <- catches.trips %>% 
  filter(ARTBEST=="Gös") %>% 
  drop_na(LANGD) %>% 
  mutate(halvmeterfisk = ifelse(LANGD>=45, 1, 0)) %>% 
  group_by(FANGOMR, Year) %>% 
  summarize('Antal fiskar' =n(),
            L10 = round(quantile(LANGD, probs = c(0.1), na.rm=T),0),
            L50 = round(quantile(LANGD, probs = c(0.5), na.rm=T), 0),
            L90 = round(quantile(LANGD, probs = c(0.9), na.rm=T), 0),
            'Andel >45cm' = round(sum(halvmeterfisk)/n()*100, 0),
            M45 = round(mean(LANGD[LANGD>45], na.rm=T), 0)) %>% 
    filter(`Antal fiskar` >9)

  
# Abborre
Lindicators.abbo <- catches.trips %>% 
  filter(ARTBEST=="Abborre") %>% 
  drop_na(LANGD) %>% 
  mutate(halvmeterfisk = ifelse(LANGD>=25, 1, 0)) %>% 
  group_by(FANGOMR, Year) %>% 
  summarize('Antal fiskar' =n(),
            L10 = round(quantile(LANGD, probs = c(0.1), na.rm=T),0),
            L50 = round(quantile(LANGD, probs = c(0.5), na.rm=T), 0),
            L90 = round(quantile(LANGD, probs = c(0.9), na.rm=T), 0),
            'Andel >25cm' = round(sum(halvmeterfisk)/n()*100, 0),
            M25 = round(mean(LANGD[LANGD>25], na.rm=T), 0)) %>% 
    filter(`Antal fiskar` >9)

    
  
### Finns många fler saker att lägga in, tex
# övrig händelse - antal per plats och säsong kanske?
# odlingsinfo - aktuellt from 2025 
# tider på dygnet - tex så här: 
# hour.plot <- catches.trips %>% filter(ARTBEST %in% c("Lax", "Röding", "Öring", "Gädda") & Year>2021 & EFTERREGISTRERING=="N") %>% ggplot(., aes(Hour)) + geom_histogram(binwidth=1, fill="#56B4E9",color="black") + facet_grid(rows=vars(FANGOMR), cols=vars(ARTBEST), scales="free_y") +  theme_bw()
# Men beakta: Vi vet när fisken reggats (under en live-tur) via FANGSTDATTID (hour), men inte när turerna körts - vilka tider. Dvs behöver justera för efforten på något sätt. 
### notera mälargäddan! Beror till stor del på mange som live-reggar i efterhand - syns med och utan hans anvid


## Lista aktiva användare tillbaka till Excelfilen ####
# Antal turer per anvid och år
active.users <- trips %>% 
  dplyr::group_by(Year, ANVID) %>% 
  dplyr::summarize(N.trips=n()) %>% 
  tidyr::pivot_wider(., names_from=Year, values_from=N.trips, values_fill=list(N.trips = 0)) %>%
  ungroup()
# lägg till infon till användarlistan (och sätt in i Excel för bra översikt)
users.export <- dplyr::left_join(users, active.users, by=c("ANV.NAMN"="ANVID")) 

# write.table(users.export, "clipboard-18488", row.names=F, quote=F, sep="\t")


```

## För perioden `r first_date` -  `r last_date`

Under perioden  har `r nusers` användare registrerat sig. Totalt har det rapporterats in `r ntrips` fisketurer, `r nfish` fångster och `r nother` interaktioner med säl och skarv. 
Av fisketurerna har `r ntrips.live` live-registrerats (`r andeltrips.live` %).


```{r table1a, echo=FALSE}
cap <- sprintf("Användare per organisation")
knitr::kable(users_tab, caption = cap)
```

```{r table1b, echo=FALSE}
cap <- sprintf("Antal aktiva användare per år, dvs hur många har registrerat minst en fisketur.")
knitr::kable(users_tab2, caption = cap)
```

```{r trip_freq, fig.cap="Frekvensdiagram av antal rapporterade fisketurer per användare och år", echo=FALSE, fig.width=5, fig.height=5}
Fig0 <- ggplot(users_temp, aes(N.trips)) + 
  geom_histogram(binwidth=1, boundary=0, closed="left", fill="grey",color="black") +
    scale_y_continuous(labels = scales::label_number(), expand=expansion(mult=c(0,0.05))) +
    xlab("Fisketurer per användare och år") + ylab("Antal") +
    guides(fill = "none", alpha = "none") + ggthemes::theme_clean() +
    theme(legend.background = element_rect(color = NA), plot.background=element_rect(color=NA))
    #facet_grid(rows=vars(FANGOMR), scales="free", cols=vars(ARTBEST))
print(Fig0)
```


```{r table2, echo=FALSE}
cap <- sprintf("Fisketurer per område och år.")
knitr::kable(trips_tab, caption = cap)
```

```{r table3, echo=FALSE}
cap <- sprintf("Målarter per område. Värdet anger antalet gånger arten har satts som målart för en fisketur.")
knitr::kable(target_tab, caption = cap)
```


```{r table4, echo=FALSE}
cap <- sprintf("Fiskar (antal individer oavsett art) per område och år.")
knitr::kable(catch_tab, caption = cap)
```

\newpage
```{r table5, echo=FALSE}
cap <- sprintf("Antal registrerade fiskar, deras medel- och maxlängd (cm) och högsta vikt (gram).")
knitr::kable(species_tab, caption = cap)
```

\newpage
## Längddata - Per art

Längdindikatorer som beräknats är kvantiler av längdfördelningen (L10-L50-L90, i cm), andelen fiskar över ett visst mått (i %) och medellängden för fiskar över detta mått (Mxx, anges i cm). Områden och år med färre än 10 individer har exkluderats. För att få en god precision i längdindikatorer behövs cirka 200-300 individer från ett standardiserat nätprovfiske. Hur många som behövs från Spöreg är okänt men borde ligga på en liknande nivå.

Storleksfördelningar visas för ett urval arter och områden.

```{r table6, echo=FALSE}
cap <- sprintf("Längdindikatorer gädda")
knitr::kable(Lindicators.pike, caption = cap)
```


```{r length_dist1, fig.cap="Storleksfördelning för gädda per område", echo=FALSE, fig.width=5, fig.height=7}
Fig1 <- catches.trips %>% filter(ARTBEST %in% c("Gädda")) %>%  # "Abborre", "Öring", "Röding", "Lax" "Gös", "Harr" separat
                                 #!FANGOMR=="Vättern") %>% 
    droplevels() %>%
    ggplot(., aes(x=LANGD, fill=FANGOMR)) +
    geom_histogram(binwidth = 5, boundary=0, closed="left",color="black") +
    scale_fill_sporeg() + 
    scale_y_continuous(labels = scales::label_number(), expand=expansion(mult=c(0,0.05))) +
    xlab("Längd (cm)") + ylab("Antal fiskar") +
    guides(fill = "none", alpha = "none") + ggthemes::theme_clean() +
    theme(legend.background = element_rect(color = NA), plot.background=element_rect(color=NA)) +
    facet_grid(rows=vars(FANGOMR), scales="free", cols=vars(ARTBEST))
print(Fig1)
```

\newpage
```{r table8, echo=FALSE}
cap <- sprintf("Längdindikatorer öring")
knitr::kable(Lindicators.trout, caption = cap)
```

```{r length_dist2, fig.cap="Storleksfördelning för öring per område", echo=FALSE, fig.width=5, fig.height=5}
Fig2 <- catches.trips %>% filter(ARTBEST %in% c("Öring"), 
                                 FANGOMR %in% c("Kust", "Vänern", "Vättern", "ÖVrigt vatten")) %>% droplevels() %>%
    ggplot(., aes(x=LANGD, fill=FANGOMR)) +
    geom_histogram(binwidth = 3, boundary=0, closed="left", color="black") +
    scale_y_continuous(labels = scales::label_number(), expand=expansion(mult=c(0,0.05))) +
    scale_fill_sporeg() + 
    xlab("Längd (cm)") + ylab("Antal fiskar") +
    guides(fill = "none", alpha = "none") + ggthemes::theme_clean() + 
    theme(legend.background = element_rect(color = NA), plot.background=element_rect(color=NA)) +
    facet_grid(rows=vars(FANGOMR), cols=vars(ARTBEST), scales="free")
print(Fig2)
```

\newpage
```{r table9, echo=FALSE}
cap <- sprintf("Längdindikatorer abborre")
knitr::kable(Lindicators.abbo, caption = cap)
```

```{r length_dist3, fig.cap="Storleksfördelning för abborre per område", echo=FALSE, fig.width=5, fig.height=3}
Fig3 <- catches.trips %>% filter(ARTBEST %in% c("Abborre"), 
                                 FANGOMR %in% c("Kust", "Mälaren")) %>% droplevels() %>%
    ggplot(., aes(x=LANGD, fill=FANGOMR)) +
    geom_histogram(binwidth = 5, boundary=0, closed="left", color="black") +
    scale_y_continuous(labels = scales::label_number(), expand=expansion(mult=c(0,0.05))) +
    scale_fill_sporeg() +
    xlab("Längd (cm)") + ylab("Antal fiskar") +
    guides(fill = "none", alpha = "none") + ggthemes::theme_clean() + 
    theme(legend.background = element_rect(color = NA), plot.background=element_rect(color=NA)) +
    facet_grid(rows=vars(FANGOMR), scales="free", cols=vars(ARTBEST))
print(Fig3)
```

\newpage
```{r table10, echo=FALSE}
cap <- sprintf("Längdindikatorer röding")
knitr::kable(Lindicators.char, caption = cap)
```

```{r table11, echo=FALSE}
cap <- sprintf("Längdindikatorer lax")
knitr::kable(Lindicators.salm, caption = cap)
```

```{r table12, echo=FALSE}
cap <- sprintf("Längdindikatorer gös")
knitr::kable(Lindicators.gos, caption = cap)
```

\newpage
## Längddata - Per område

```{r length_dist4, fig.cap="Storleksfördelning för arter i Vättern", echo=FALSE, fig.width=7, fig.height=5}
Fig4 <- catches.trips %>% filter(ARTBEST %in% c("Röding", "Öring", "Lax"), 
                                 FANGOMR=="Vättern") %>% droplevels() %>%
    ggplot(., aes(x=LANGD, fill=FANGOMR)) +
    geom_histogram(binwidth = 5, boundary=0, closed="left", color="black") +
    scale_y_continuous(labels = scales::label_number(), expand=expansion(mult=c(0,0.05))) +
    scale_fill_sporeg() + 
    xlab("Längd (cm)") + ylab("Antal fiskar") +
    guides(fill = "none", alpha = "none") + ggthemes::theme_clean() + 
    theme(legend.background = element_rect(color = NA), plot.background=element_rect(color=NA)) +
    facet_grid(rows=vars(FANGOMR), scales="free", cols=vars(ARTBEST))
print(Fig4)
```


```{r length_dist5, fig.cap="Storleksfördelning för arter i Vänern", echo=FALSE, fig.width=7, fig.height=5}
Fig5 <- catches.trips %>% filter(ARTBEST %in% c("Gädda", "Lax", "Öring"), 
                                 FANGOMR %in% c("Vänern")) %>% droplevels() %>%
    ggplot(., aes(x=LANGD, fill=FANGOMR)) +
    geom_histogram(binwidth = 5, boundary=0, closed="left", color="black") +
    scale_y_continuous(labels = scales::label_number(), expand=expansion(mult=c(0,0.05))) +
    scale_fill_sporeg() + 
    xlab("Längd (cm)") + ylab("Antal fiskar") +
    guides(fill = "none", alpha = "none") + ggthemes::theme_clean() + 
    theme(legend.background = element_rect(color = NA), plot.background=element_rect(color=NA)) +
    facet_grid(rows=vars(FANGOMR), scales="free", cols=vars(ARTBEST))
print(Fig5)
```


```{r length_dist6, fig.cap="Storleksfördelning för arter i Mälaren", echo=FALSE, fig.width=7, fig.height=5}
Fig6 <- catches.trips %>% filter(ARTBEST %in% c("Gädda", "Abborre", "Gös"), 
                                 FANGOMR %in% c("Mälaren")) %>% droplevels() %>%
  ggplot(., aes(x=LANGD, fill=FANGOMR)) +
  geom_histogram(binwidth = 5, boundary=0, closed="left",color="black") +
  scale_y_continuous(labels = scales::label_number(), expand=expansion(mult=c(0,0.05))) +
  scale_fill_sporeg() + 
  xlab("Längd (cm)") + ylab("Antal fiskar") +
  guides(fill = "none", alpha = "none") + ggthemes::theme_clean() + 
  theme(legend.background = element_rect(color = NA), plot.background=element_rect(color=NA)) +
  facet_grid(rows=vars(FANGOMR), scales="free", cols=vars(ARTBEST))
print(Fig6)
```


\newpage
## Kartor
 
```{r map_overview, echo=FALSE, fig.cap="Rapporterade startpositioner för alla turer under perioden", fig.width=8, fig.height=8}
# need extra step to handle some coordinates that are clearly wrong..
pal <- c("#56B4E9", "#009E73", "#F0E442", "#0072B2", "#E69F00", "#D55E00") # denna från fiskbarometerns instruktioner
pal2 <- c("#007681", "#509e2f", "#fce300", "#996017", "#ff585d", "#6ad1e3", "#53565a") # denna från SLU:s färgpalett


# Behöver ge samma namn på koordinaterna för att kunna binda ihop positioner från resa och fångst:
catches.trips$POSITIONE <- catches.trips$POSITIONE.x
catches.trips$POSITIONN <- catches.trips$POSITIONN.x

koords <- rbind(trips[,c("POSITIONE", "POSITIONN")], catches[,c("POSITIONE","POSITIONN")])
koords2 <- filter(koords, POSITIONN >45)
## Bounding box for whole of Sweden
bbox <- sporeg_bbox(koords2, buffer=1) 
upperleft <- c(bbox["top"], bbox["left"])
lowerright <- c(bbox["bottom"], bbox["right"])
map_os <- OpenStreetMap::openproj(
  OpenStreetMap::openmap(upperleft, lowerright, type="osm"),
  projection = "EPSG:4326")
bgmap <-  raster::raster(map_os)
## Bounding box for Stockholm area 
bbox2 <- c(left=15, bottom=58.75, right=19.5, top=60)
upperleft2 <- c(bbox2["top"], bbox2["left"])
lowerright2 <- c(bbox2["bottom"], bbox2["right"])
map_os2 <- OpenStreetMap::openproj(
  OpenStreetMap::openmap(upperleft2, lowerright2, type="osm"),
  projection = "EPSG:4326")
bgmap2 <-  raster::raster(map_os2)


# Map of trips
map.trips <- ggplot2::ggplot() +
  terrainr::geom_spatial_rgb(
    data = bgmap,
    aes(x = x, y = y, r = red, g = green, b = blue)) +
  ggplot2::geom_point(data = filter(trips, POSITIONN >45, !MALART %in% c("Björkna", "Id", "Storspigg", "Asp")),
    aes(x = POSITIONE, y = POSITIONN, col=EFTERREGISTRERING), alpha=0.4,
    size = 3, show.legend = T) +
  scale_color_manual(values = c("#509e2f", "#ff585d")) +
  xlab("") + ylab("") + 
  ggplot2::theme_bw() +
  ggplot2::coord_cartesian() + 
  theme(legend.position="bottom")
print(map.trips)
```


```{r map_overview2a, echo=FALSE, fig.cap="Rapporterade fångstpositioner per art", fig.width=8, fig.height=8}
# Map of catches (Sweden)
map.catches <- ggplot2::ggplot() +
  terrainr::geom_spatial_rgb(
    data = bgmap,
    aes(x = x, y = y, r = red, g = green, b = blue)) +
  ggplot2::geom_point(data = filter(catches, POSITIONN >45, 
                                    ARTBEST %in% species_keep), # keep only species above catch threshold
                      aes(x = POSITIONE, y = POSITIONN, col=ARTBEST),
                      size=3, alpha=0.7, show.legend = T) +
  scale_color_sporeg_art() + 
  xlab("") + ylab("") + 
  ggplot2::theme_bw() +
  ggplot2::coord_cartesian() + 
  theme(legend.position="bottom", legend.title=element_blank())
print(map.catches)
```

```{r map_overview2b, echo=FALSE, fig.cap="Rapporterade fångstpositioner per art (inzoomat)", fig.width=8, fig.height=8}
# Map of catches (zoom)
map.catches2 <- ggplot2::ggplot() +
  terrainr::geom_spatial_rgb(
    data = bgmap2,
    aes(x = x, y = y, r = red, g = green, b = blue)) +
  ggplot2::geom_point(data = filter(catches, 
                                    POSITIONN <bbox2[["top"]] & POSITIONN >bbox2[["bottom"]],  # filtering by the box to filter ARTBEST legend
                                    POSITIONE <bbox2[["right"]] & POSITIONE >bbox2[["left"]],
                                    ARTBEST %in% species_keep), # keep only species above catch threshold
                      aes(x = POSITIONE, y = POSITIONN, col=ARTBEST),
                      size=3, alpha=0.7, show.legend = T) +
  scale_color_sporeg_art() + 
  xlab("") + ylab("") + 
  ggplot2::theme_bw() +
  ggplot2::coord_cartesian(xlim=c(bbox2["left"], bbox2["right"]),
                           ylim=c(bbox2["bottom"], bbox2["top"])) + 
  theme(legend.position="bottom", legend.title=element_blank())
print(map.catches2)
```



```{r map_overview3, echo=FALSE, fig.cap="Rapporterade positioner för övriga händelser", fig.width=8, fig.height=8}
# map of other
# Note that coordinates for other are not checked and could be outside trip and catches...
map.other <- ggplot2::ggplot() +
  terrainr::geom_spatial_rgb(
    data = bgmap,
    aes(x = x, y = y, r = red, g = green, b = blue)) +
  ggplot2::geom_point(data = other,
    aes(x = POSITIONE, y = POSITIONN, col=HANDELSE),
    size=3, alpha=0.8, show.legend = T) +
  scale_color_manual(values = c("#53565a", "#79863c")) +
  ggplot2::theme_bw() +
  ggplot2::coord_cartesian() + 
  theme(legend.position="bottom", legend.title=element_blank())
print(map.other)
```



\newpage
## Övrigt
```{r other1a, fig.cap="Förhållandet mellan vikt och längd för ett urval arter och vatten.", echo=FALSE, message=FALSE, fig.width=8, fig.height=8}
Fig.WL <- catches.trips %>% filter(ARTBEST %in% c("Abborre", "Gädda", "Gös", "Lax", "Öring", "Röding"),
                                   FANGOMR %in% c("Kust", "Mälaren", "Vänern", "Vättern"),
                                   !is.na(VIKT), !is.na(LANGD)) %>% 
                            droplevels() %>%
ggplot(., aes(x=LANGD, y=VIKT, col=ARTBEST)) + # col=is_est_VIKT)) +
  geom_point(size=2, alpha=0.6) +
  geom_smooth(se=F, col="black") +
  #scale_color_manual(values = c("#56B4E9","#009E73","black")) +
  scale_y_continuous(labels = scales::label_number(), expand=expansion(mult=c(0,0.05))) +
  xlab("Längd (cm)") + ylab("Vikt (g)") +
  guides(fill = "none", alpha = "none") + theme_bw() + 
  theme(legend.background = element_rect(color = NA), 
        plot.background=element_rect(color=NA),
        legend.position = "below") +
  #facet_grid(rows=vars(ARTBEST), cols=vars(FANGOMR), scales="free")
  facet_wrap(~ARTBEST, scales="free") + 
  scale_color_sporeg_art()
print(Fig.WL)

```

```{r other1b, fig.cap="Log-log-förhållandet mellan vikt och längd för ett urval arter och vatten.", echo=FALSE, message=FALSE, fig.width=8, fig.height=8}

 # Det är två gäddor från Lasse Lindahl som har fel vikt, på kusten, ska troligen vara 800 g, inte 8000...
 # foo <- catches.trips %>% filter(ANVID == "lassel", VIKT>7999, ARTBEST=="Gädda", FANGOMR=="Kust",)
 # foo
 # Även denna abborre ska ändras (petersfiske), från VIKT 3500 till 350:
  # catches.trips %>% filter(ARTBEST=="Abborre", FANGOMR=="Kust", VIKT>3000)
 # Ett gäng gäddor som fått vikter i kg istället för gram...:
 # foo <- catches.trips %>% filter(ARTBEST=="Gädda", log(VIKT)<4)
 ## Enklaste sätten att upptäcka detta är på log-log skala
 ## Behöver ett litet script som identifierar potentiella problem och sen rutin för att åtgärda i databasen
## Identifiera outliers med fel vikt-längd:
bar <- catches.trips %>% 
  filter(ARTBEST %in% c("Abborre", "Gädda", "Gös", "Lax", "Öring", "Röding"),
         FANGOMR %in% c("Kust", "Mälaren", "Vänern", "Vättern"),
         !is.na(VIKT), !is.na(LANGD)) %>% 
  select(UUID, ARTBEST, LANGD, is_est_LANGD, VIKT, is_est_VIKT, ANVID, NAMN, RESEDATUM, FANGOMR, Year) %>% 
  mutate(logL = log(LANGD),
         logW = log(VIKT)) %>%
  droplevels() 
  
WL.log <- ggplot(bar, aes(x=logL, y=logW, col=ARTBEST)) +
  geom_point(size=2, alpha=0.6) + 
  geom_smooth(method="lm", se=F, col="black") +
  scale_y_continuous(labels = scales::label_number(), expand=expansion(mult=c(0,0.05))) +
  facet_wrap(~ARTBEST, scales="free") + 
  guides(fill = "none", alpha = "none") + theme_bw() + 
  theme(legend.background = element_rect(color = NA), 
        plot.background=element_rect(color=NA),
        legend.position = "none") +
  scale_color_sporeg_art() + 
  ggpmisc::stat_poly_eq(ggpmisc::use_label(c("R2", "p", "n")), col="black") 

print(WL.log)
```

\newpage
## Återutsättning
```{r release_table, echo=FALSE, message=FALSE}
## Create a table for release rates by species
# Need to consider both "N" and "J" since default is "NA". I.e., the levels of ATERUTSATT varies with anvid.
#fangst[is.na(fangst$ATERUTSATT), "ATERUTSATT"] <- "Ejangett"
#fangst$ATERUTSATT <- factor(fangst$ATERUTSATT, levels=c("J", "N", "Ejangett"))
t3 <- catches.trips %>%
  rename(Art = ARTBEST) %>%
  mutate(ATERUTSATT = if_else(is.na(ATERUTSATT), "N/A", ATERUTSATT)) %>%
  mutate(ATERUTSATT = factor(ATERUTSATT, levels = c("J", "N", "N/A"))) %>%
  dplyr::group_by(Art, ATERUTSATT) %>%
  dplyr::summarize(N=n(), .groups = "drop") %>% 
  tidyr::pivot_wider(values_from = N, names_from = ATERUTSATT, values_fill=0, names_expand = TRUE) %>% 
  mutate(Andel = round(J / (J+N),3)) %>% 
  arrange(desc(J))
  

cap <- "J = antal återutsatta, N = antal behållna, N/A = ej angett och andel återutsatt."
knitr::kable(t3, caption = cap) 
```

\newpage
## Vild/odlad
Inställningen i appen för odlad eller vild fisk har till och med version 2.4.4. varit att fisken rapporteras som ODLAD = N om inget annat anges. Det innebär att andelen vild fisk riskerar att överskattas. Inställningen ändrades från och med version 2.4.5 och andelen vild blir korrekt beräknad från och med 2025.

```{r odlad_table, echo=FALSE, message=FALSE}
# Need to consider that default was "N" (ODLAD) up to and including 2024. From 2025 it is fixed to default=NA.
# Code below considers only confirmed reared - needs to be changed for 2025 yearly report
reared.tab <- 
  catches.trips %>% 
  filter(ARTBEST %in% c("Lax", "Öring")) %>% 
  group_by(ARTBEST, FANGOMR, Year, ODLAD) %>% #KLIPPTFENAHOGER, KLIPPTFENAVANSTER
  summarize(N=n()) %>% 
  pivot_wider(names_from=ODLAD, values_from=N, values_fill = 0) %>% 
  mutate(`Andel vild` = round(N / (N+J),3)) %>% 
  filter(!(ARTBEST == "Lax" & FANGOMR == "Vättern"), # Ta bort lax i Vättern, inte relevant
         Year >2024) %>% # filtrerar också bort tidigare år då det var fel default
  ungroup() %>% 
  select(-Year) %>% 
  rename(Vild = N, `Ej angett` = `NA`, Odlad = J) %>% 
  relocate(Odlad, .after = Vild) 

### Also provide information for Vänern on detailed fin clipping
# Note - default is N for KLIPPTFENAHOGER/VANSTER!
# Therefore only provide information on how many of the ODLAD=J that have also fin clippings
# Include all years? Yes, to start with. Note that 2025 there are no reportings of this. Perhaps drop in future.
 #catches.trips %>% 
  # filter(ARTBEST %in% c("Lax", "Öring"),
  #       FANGOMR == "Vänern",
  #       ODLAD == "J") %>% 
  # count(ARTBEST, Year, ODLAD, KLIPPTFENAHOGER, KLIPPTFENAVANSTER)
odlad.öring.vänern <- 
  catches.trips %>% filter(ARTBEST=="Öring", FANGOMR=="Vänern", ODLAD=="J") %>% 
  count() %>% pull()
höger.öring.vänern <- 
  catches.trips %>% filter(ARTBEST=="Öring", FANGOMR=="Vänern", ODLAD=="J", KLIPPTFENAHOGER=="J") %>% 
  count() %>% pull()
vänster.öring.vänern <- 
  catches.trips %>% filter(ARTBEST=="Öring", FANGOMR=="Vänern", ODLAD=="J", KLIPPTFENAVANSTER=="J") %>% 
  count() %>% pull()

odlad.lax.vänern <- 
  catches.trips %>% filter(ARTBEST=="Lax", FANGOMR=="Vänern", ODLAD=="J") %>% 
  count() %>% pull()
höger.lax.vänern <- 
  catches.trips %>% filter(ARTBEST=="Lax", FANGOMR=="Vänern", ODLAD=="J", KLIPPTFENAHOGER=="J") %>% 
  count() %>% pull()
vänster.lax.vänern <- 
  catches.trips %>% filter(ARTBEST=="Lax", FANGOMR=="Vänern", ODLAD=="J", KLIPPTFENAVANSTER=="J") %>% 
  count() %>% pull()
  
cap <- "Antal och andel vilda och odlade laxar och öringar per område från och med 2025."
knitr::kable(reared.tab, caption = cap) 
```

I Vänern har det för perioden rapporterats `r odlad.öring.vänern` odlade öringar, varav `r höger.öring.vänern` också har rapporterats ha klippt bukfena höger, och 
`r vänster.öring.vänern` klippt bukfena vänster.
Motsvarande för lax är `r odlad.lax.vänern` odlade, varav `r höger.lax.vänern` med klippt bukfena höger och `r vänster.lax.vänern` klippt bukfena vänster.
