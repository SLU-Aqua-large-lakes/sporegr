---
title: "Användarrapport"
author: "Spöreg"
date: "`r Sys.Date()`"
output:
  pdf_document: default
  html_document: default
  word_document: default
header-includes: 
  - \usepackage[labelfont=bf]{caption}
  - \captionsetup{justification=raggedright,singlelinecheck=false}
  - \renewcommand{\figurename}{Figur}
  - \renewcommand{\tablename}{Tabell}
  - \renewcommand{\contentsname}{Innehåll}
params:
  anvid: peterguide
  year_no: 2022
---


```{r setup, include=FALSE}
# setwd("~/sporeg")

library(sporegr)
library(dplyr)
library(ggplot2)

knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)

#anvid <- "mange"
#year_no <- 2022
#month_no <- 8
anvid <- params$anvid
year_no <- params$year_no

# Load and prep data...
#resa_name <- "Spöreg Resa.csv"
#ovrighandelse_name <- "Spöreg Övrighändelse.csv"
#fangst_name <- "Spöreg Fångst.csv"
resa_name <- "Spöreg Resa.xlsx"
ovrighandelse_name <- "Spöreg Övrighändelse.xlsx"
fangst_name <- "Spöreg Fångst.xlsx"

# ... using functions included in library(sporeg)
resa <- read_resa_clean(resa_name)  %>% filter(ANVID == anvid, Year == year_no)
resor_uuid <- resa %>% pull(UUID) %>% unique()
ovrighandelse <- read_ovrighandelse_clean(ovrighandelse_name) %>%
  filter(UUID %in% resor_uuid)
fangst <- read_fangst_clean(file_name = fangst_name) %>% filter(UUID %in% resor_uuid)
fangst <- fix_fangst_missing_fangstdattid(fangst, resa)
have_fangst <- nrow(fangst) > 0

# put together trip and catch
fangst_resa <- resa %>%
  right_join(fangst, by = c("UUID" = "UUID"))


## Andel återutsatt behöver beakta både "N" och "J" eftersom default är "NA". 
# Skip for now. If used later, place below in its own chunk.
released_fangst <- fangst %>%
  filter(ATERUTSATT == "J") %>%
  summarise(released_fangst = n()) %>%
  pull(released_fangst)

```

## Inrapporterat data för användare `r anvid`  

```{r prep-inledning}
first_date <- min(resa$RESEDATUM)
last_date <- max(resa$RESEDATUM)
all_dates <- seq(from = as.Date(first_date), to = as.Date(last_date), by = 1)
tot_fangst <- nrow(fangst)
```

Totalt har *`r anvid`* rapporterat `r nrow(resa)` resor och `r tot_fangst` fiskar under perioden `r first_date` till `r last_date`. 

```{r map_overview, fig.cap="Rapporterad startposition för alla resor under perioden", fig.alt="Karta alla resor"}
bbox <- sporeg_bbox(resa)
upperleft <- c(bbox["top"], bbox["left"])
lowerright <- c(bbox["bottom"], bbox["right"])
map <- OpenStreetMap::openmap(upperleft, lowerright, type="osm")
bgmap <- RStoolbox::ggRGB(raster::raster(OpenStreetMap::openproj(map)), r = 1, g = 2, b = 3) +
  ggplot2::geom_point(aes(x = POSITIONE, y = POSITIONN), fill = "red", shape = 23,
                      size = 2, data = resa, show.legend = FALSE) +
  ggplot2::coord_cartesian()
print(bgmap)

#bgmap <- ggmap::get_map(sporeg_bbox(resa), maptype = "hybrid")
#bgmap <- OpenStreetMap::openmap()
#ggmap::ggmap(bgmap) +
#  ggplot2::geom_point(aes(x = POSITIONE, y = POSITIONN), fill = "red", shape = 23,
#                      size = 2, data = resa, show.legend = FALSE)

```


## Fångst över tid

```{r resa_summary_table}
t1 <- resa %>% select(NAMN,RESEDATUM, FANGOMR, MALART, ANTALPERSONER, FISKEMINUTER, UUID)
t2 <- fangst %>% group_by(UUID, ARTBEST) %>% summarise(Antal = n(), 
                                                       MaxLangd = max(LANGD)/10, .groups = "drop")
## Peterguide kommenterar att medellängd och längsta kan vara bra i tabellen. Testar ersätta cpue med längsta per tur
 resa_summary <- t1 %>%
  left_join(t2, by = c("UUID" = "UUID", "MALART" = "ARTBEST")) %>%
     select(Resa = NAMN, Datum = RESEDATUM, Målart = MALART, Område = FANGOMR,
            Personer = ANTALPERSONER, Minuter = FISKEMINUTER,
            `Fångst (målart)` = Antal, `Längsta fisk (cm)` = MaxLangd) %>% 
     tidyr::replace_na(list(`Fångst (målart)`=0, `Längsta fisk (cm)`=0))
  #mutate(`Fångstindex (antal per spötimme)` = round(`Fångst (målart)` / (Minuter/60*Personer),2))
   
cap <- paste0("Alla resor under perioden")
kableExtra::kbl(resa_summary, caption = cap, booktabs = TRUE, linesep="",
                longtable = TRUE) %>%
  kableExtra::kable_styling(latex_options = c("repeat_header", "scale_down", "HOLD_position"))
#kableExtra::kbl(resa_summary, caption = cap)
```

Fångster över tid beskrivs först som totalt antal fångade fiskar per resa, uppdelat per art (Figur 1). Sen som ett fångstindex beräknat som fångst per ansträngning (Figur 2). Fångst är då beräknat som antal fångade fiskar av målarten och ansträngning som spötimmar (antal personer * antal timmar).

```{r per-date-plot, fig.cap = "Fångst per resa"}
#Create plot with catch per day. One panel per species caught
per_date_plot <- fangst_resa %>% group_by(RESEDATUM, ARTBEST) %>% summarise(Antal = n(), .groups = "drop") %>% 
    ggplot(., mapping = aes(x = RESEDATUM, y = Antal, fill = ARTBEST)) +
          geom_col() +
          facet_grid(scales = "free_y", rows = vars(ARTBEST)) +
            # date_breaks måste anpassas till hur många dagar man har, calc_date_breaks() försöker fixa
            scale_x_date(date_breaks = calc_date_breaks(first_date, last_date) , date_labels = "%b-%d",
                         guide = guide_axis(angle = 60), expand = c(0, 0)) +
          scale_y_continuous(breaks = integer_breaks()) +
          theme(legend.position='none') + xlab("")

if (have_fangst) {
  print(per_date_plot)
} else {
  print("Inga fångster")
}
```


```{r cpue-plot, fig.cap="Fångstindex"}
# To look at catch index we need to take MALART and FANGOMR into account
cpuedata <- fangst_resa %>% filter(MALART==ARTBEST) %>%               
    group_by(RESEDATUM, FANGOMR, MALART) %>% 
    summarise(Antal = n(), 
              Effort = max(FISKEMINUTER)/60 * max(ANTALPERSONER),
              cpue = round(Antal/Effort,2), .groups="drop")

## Plot catch index over time, by target species
cpue_per_date_plot <- cpuedata %>% 
    ggplot(., aes(x = RESEDATUM, y = cpue, fill = FANGOMR)) +
            geom_line(aes(col=FANGOMR)) + geom_point(size=2, aes(col=FANGOMR)) + 
            facet_grid(scales = "free_y", rows = vars(MALART)) +
            # date_breaks måste anpassas till hur många dagar man har, calc_date_breaks() försöker fixa
            scale_x_date(date_breaks = calc_date_breaks(first_date, last_date) , date_labels = "%b-%d",
                         guide = guide_axis(angle = 60), expand = c(0, 0)) +
            #scale_y_continuous(breaks = integer_breaks()) + 
            theme(legend.position='bottom') + labs(fill="Område", col="Område") +
            ylab("Fångstindex (antal per spötimme)") + xlab("")

if (have_fangst) {
  print(cpue_per_date_plot)
} else {
  print("Inga fångster")
}
```



## Längdfördelning(ar)

```{r individ_summary_table}
fangst_per_art <- fangst_resa %>% 
  group_by(FANGOMR, ARTBEST) %>% 
  summarise(Antal = n(), 
            Längsta = max(LANGD),
            .groups = "drop") %>%
  rename(Art = ARTBEST,
         Område = FANGOMR)

cap <- "Totalt antal fiskar samt största exemplar (mm)"
kableExtra::kbl(fangst_per_art, caption = cap, booktabs = TRUE, linesep="",
                longtable = TRUE, centering = FALSE) %>%
  kableExtra::kable_styling(latex_options = c("HOLD_position"), position = "left")

#knitr::kable(fangst_per_art, caption = cap)
```

```{r big_fish}
Ngadda <- as.numeric(fangst %>% filter(ARTBEST=="Gädda") %>% summarise(N=n()))
storgadda <- as.numeric(fangst %>% filter(ARTBEST=="Gädda" & LANGD>=1000) %>% summarise(N=n()))
prcntstor <- round(storgadda/Ngadda*100,2)
mediumgadda <- as.numeric(fangst %>% filter(ARTBEST=="Gädda" & LANGD>=750) %>% summarise(N=n()))
prcntmedium <- round(mediumgadda/Ngadda*100,2)
```

Av totalt `r Ngadda` rapporterade gäddor var `r storgadda` st över en meter (`r prcntstor` %) och `r mediumgadda` st var över 75 cm (`r prcntmedium` %). 


```{r length_dist, fig.cap="Antal fiskar per längdgrupp"}
length_dist <- fangst %>%
  group_by(ARTBEST) %>%
  mutate(n = n()) %>%
  filter(n > 10) %>%
  ggplot(mapping = aes(x = LANGD/10)) +
  geom_histogram( binwidth = 5) +
  scale_y_continuous(labels = scales::label_number()) +
  facet_grid(scales = "free_y", rows = vars(ARTBEST)) +
  xlab("Längd (cm)") + ylab("Antal fiskar")

if (have_fangst) {
  print(length_dist)
} else {
  print("Inga fångster")
}
```
